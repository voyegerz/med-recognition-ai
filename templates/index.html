<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharma Vision | Intelligent Medicine Recognition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        medical: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .details-scroll::-webkit-scrollbar { width: 6px; }
        .details-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center py-10 px-4 overflow-x-hidden">

    <div class="w-full max-w-4xl flex justify-between items-center mb-10">
        <div class="flex items-center gap-3">
            <div class="bg-medical-600 text-white p-2 rounded-lg shadow-lg">
                <i class="fas fa-heartbeat text-2xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Pharma Vision</h1>
                <p class="text-xs text-slate-500 font-medium tracking-wide uppercase">Wrapper Recognition System</p>
            </div>
        </div>
        <button onclick="toggleHistory()" class="group flex items-center gap-2 text-slate-500 hover:text-medical-600 transition bg-white px-4 py-2 rounded-full shadow-sm border border-slate-200 hover:border-medical-200">
            <i class="fas fa-history text-lg group-hover:rotate-180 transition-transform duration-500"></i>
            <span class="font-medium text-sm">History</span>
        </button>
    </div>

    <main class="w-full max-w-4xl bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 relative z-10">
        <div class="grid md:grid-cols-2 gap-0">
            
            <div class="p-8 bg-slate-50 border-r border-slate-100 flex flex-col justify-center">
                <div id="drop-zone" class="relative group border-2 border-dashed border-medical-500/30 hover:border-medical-500 bg-white rounded-2xl p-8 text-center transition-all cursor-pointer h-80 flex flex-col items-center justify-center">
                    <input type="file" id="file-input" class="hidden" accept="image/*">
                    <div id="upload-prompt" class="transition-opacity duration-300">
                        <div class="w-16 h-16 bg-medical-50 text-medical-500 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                            <i class="fas fa-cloud-upload-alt text-3xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-700">Upload Wrapper</h3>
                        <p class="text-sm text-slate-400 mt-2">Click or drag & drop image</p>
                    </div>
                    <img id="image-preview" class="absolute inset-0 w-full h-full object-contain p-4 hidden rounded-2xl bg-slate-900/5 backdrop-blur-sm" alt="Preview">
                </div>
                <button id="analyze-btn" disabled class="mt-6 w-full py-3.5 bg-slate-200 text-slate-400 font-semibold rounded-xl shadow-sm transition-all flex items-center justify-center gap-2 cursor-not-allowed">
                    <span>Select Image First</span>
                </button>
            </div>

            <div class="p-8 relative min-h-[500px]">
                <div id="initial-state" class="absolute inset-0 flex flex-col items-center justify-center text-center p-8 text-slate-400">
                    <i class="fas fa-microscope text-6xl mb-4 opacity-20"></i>
                    <p>AI analysis results will appear here.</p>
                </div>

                <div id="loading" class="hidden absolute inset-0 bg-white z-20 flex flex-col items-center justify-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-medical-600 mb-4"></div>
                    <p class="text-medical-600 font-medium animate-pulse">Analyzing OCR patterns...</p>
                </div>

                <div id="results" class="hidden fade-in h-full flex flex-col">
                    <div class="mb-6 pb-4 border-b border-slate-100">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 id="med-name" class="text-2xl font-bold text-slate-800">--</h2>
                                <p id="med-company" class="text-sm text-slate-500 mt-1">--</p>
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                <span id="med-confidence" class="px-2 py-1 bg-gray-100 text-gray-700 text-xs font-bold rounded">--</span>
                                <span id="med-cert" class="text-xs text-slate-400 border border-slate-200 px-1.5 rounded">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex bg-slate-100 p-1 rounded-lg mb-4">
                        <button onclick="switchTab('english')" id="tab-english" class="flex-1 py-2 text-sm font-medium rounded-md shadow-sm bg-white text-medical-600 transition-all">English</button>
                        <button onclick="switchTab('hindi')" id="tab-hindi" class="flex-1 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-700 transition-all">Hindi</button>
                        <button onclick="switchTab('gujarati')" id="tab-gujarati" class="flex-1 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-700 transition-all">Gujarati</button>
                    </div>

                    <div class="flex-1 overflow-y-auto details-scroll pr-2 space-y-4">
                        <div id="content-english" class="tab-content text-sm space-y-4"></div>
                        <div id="content-hindi" class="tab-content hidden text-sm space-y-4"></div>
                        <div id="content-gujarati" class="tab-content hidden text-sm space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="history-overlay" onclick="toggleHistory()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-40 hidden transition-opacity opacity-0"></div>

    <aside id="history-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out border-l border-slate-100 flex flex-col">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <h3 class="font-bold text-slate-700"><i class="fas fa-history text-medical-600 mr-2"></i>Recent Scans</h3>
            <button onclick="toggleHistory()" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
        </div>
        
        <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-3 details-scroll">
            <div class="text-center text-slate-400 mt-10">
                <div class="animate-spin inline-block w-6 h-6 border-2 border-slate-300 border-t-medical-600 rounded-full"></div>
            </div>
        </div>
    </aside>

    <script>
        // --- Existing Variables ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const imagePreview = document.getElementById('image-preview');
        const uploadPrompt = document.getElementById('upload-prompt');
        const analyzeBtn = document.getElementById('analyze-btn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const initialState = document.getElementById('initial-state');
        
        // --- History Variables ---
        const historySidebar = document.getElementById('history-sidebar');
        const historyOverlay = document.getElementById('history-overlay');
        const historyList = document.getElementById('history-list');
        let isHistoryOpen = false;

        // --- Core Functions ---
        
        async function toggleHistory() {
            isHistoryOpen = !isHistoryOpen;
            
            if (isHistoryOpen) {
                // Open UI
                historySidebar.classList.remove('translate-x-full');
                historyOverlay.classList.remove('hidden');
                setTimeout(() => historyOverlay.classList.remove('opacity-0'), 10);
                
                // Fetch Data
                try {
                    const response = await fetch('/history');
                    const data = await response.json();
                    renderHistory(data);
                } catch (e) {
                    historyList.innerHTML = `<p class="text-red-500 text-center text-sm mt-4">Failed to load history</p>`;
                }
            } else {
                // Close UI
                historySidebar.classList.add('translate-x-full');
                historyOverlay.classList.add('opacity-0');
                setTimeout(() => historyOverlay.classList.add('hidden'), 300);
            }
        }

        function renderHistory(items) {
            if (items.length === 0) {
                historyList.innerHTML = `<p class="text-slate-400 text-center text-sm mt-10">No scans yet.</p>`;
                return;
            }

            historyList.innerHTML = items.map(item => `
                <div onclick='restoreScan(${JSON.stringify(item.full_data).replace(/'/g, "&#39;")})' 
                     class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:border-medical-300 cursor-pointer transition-all group">
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-bold text-slate-700 text-sm group-hover:text-medical-600 truncate">${item.name}</h4>
                        <span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">${item.time}</span>
                    </div>
                    <p class="text-xs text-slate-400 truncate">${item.full_data?.company_info?.name || 'Unknown Company'}</p>
                </div>
            `).join('');
        }

        function restoreScan(data) {
            if (!data) return;
            // Populate the main result view with the historical data
            displayResults(data);
            toggleHistory(); // Close sidebar
            
            // UI Reset specific to restore
            imagePreview.src = ""; // We don't have the image blob stored for re-display easily, keep it blank or placeholder
            imagePreview.classList.add('hidden');
            uploadPrompt.classList.remove('opacity-0');
        }

        // --- Existing Logic (Drag & Drop + API) ---

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-medical-500', 'bg-medical-50'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('border-medical-500', 'bg-medical-50'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('border-medical-500', 'bg-medical-50'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.classList.remove('hidden');
                uploadPrompt.classList.add('opacity-0');
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                analyzeBtn.classList.add('bg-medical-600', 'hover:bg-medical-700', 'text-white', 'shadow-md');
                analyzeBtn.innerHTML = `<i class="fas fa-search"></i> Identify Medicine`;
                results.classList.add('hidden');
                initialState.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        analyzeBtn.addEventListener('click', async () => {
            loading.classList.remove('hidden');
            initialState.classList.add('hidden');
            analyzeBtn.disabled = true;
            analyzeBtn.classList.add('opacity-75');
            const formData = new FormData();
            formData.append('image', fileInput.files[0]); // Use fileInput directly

            try {
                const response = await fetch('/analyze', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                displayResults(data);
            } catch (err) {
                alert('Analysis failed: ' + err.message);
                initialState.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('opacity-75');
            }
        });

        function displayResults(data) {
            initialState.classList.add('hidden');
            results.classList.remove('hidden');
            
            document.getElementById('med-name').textContent = data.medicine_name || "Unknown";
            document.getElementById('med-company').textContent = data.company_info?.name || "Unknown";
            document.getElementById('med-cert').textContent = data.company_info?.certification || "N/A";
            
            const confEl = document.getElementById('med-confidence');
            confEl.textContent = data.confidence_score || "Low";
            confEl.className = `px-2 py-1 text-xs font-bold rounded ${
                data.confidence_score === 'High' ? 'bg-green-100 text-green-700' : 
                data.confidence_score === 'Medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
            }`;

            renderTabContent('english', data.details.english);
            renderTabContent('hindi', data.details.hindi);
            renderTabContent('gujarati', data.details.gujarati);
            switchTab('english');
        }

        function renderTabContent(lang, info) {
            const container = document.getElementById(`content-${lang}`);
            if(!info) return;
            container.innerHTML = `
                <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                    <h3 class="font-semibold text-medical-700 mb-1"><i class="fas fa-prescription-bottle-alt mr-2"></i>Usage</h3>
                    <p class="text-slate-600 leading-relaxed">${info.usage}</p>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <h3 class="font-semibold text-slate-700 mb-1"><i class="fas fa-clock mr-2 text-slate-400"></i>Dosage</h3>
                    <p class="text-slate-600 leading-relaxed">${info.dosage}</p>
                </div>
                ${info.warnings ? `<div class="bg-red-50 p-4 rounded-xl border border-red-100">
                    <h3 class="font-semibold text-red-700 mb-1"><i class="fas fa-exclamation-triangle mr-2"></i>Warning</h3>
                    <p class="text-red-600 leading-relaxed">${info.warnings}</p>
                </div>` : ''}
            `;
        }

        window.switchTab = (lang) => {
            ['english', 'hindi', 'gujarati'].forEach(l => {
                document.getElementById(`content-${l}`).classList.add('hidden');
                document.getElementById(`tab-${l}`).className = "flex-1 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-700 transition-all";
            });
            document.getElementById(`content-${lang}`).classList.remove('hidden');
            document.getElementById(`tab-${lang}`).className = "flex-1 py-2 text-sm font-medium rounded-md shadow-sm bg-white text-medical-600 ring-1 ring-slate-200 transition-all";
        };
    </script>
</body>
</html>